{# _form_fields.html #}
{% macro render_form_fields(model_info, record=None, show_advanced=True) %}
    {# Regular Fields #}
    {% for field_name, field in model_info.fields.items() %}
    {% if field_name not in ['id', 'created_at', 'updated_at', 'deleted_at'] %}
    <div class="p-6">
        <label class="block text-sm font-medium text-gray-700" for="{{ field_name }}">
            {{ field_name }}
            {% if field.required %}
            <span class="text-red-500">*</span>
            {% endif %}
        </label>

        <div class="mt-2">
            {% if field.__class__.__name__ == 'BooleanField' %}
            <label class="inline-flex items-center">
                <input type="checkbox"
                       id="{{ field_name }}"
                       name="{{ field_name }}"
                       {% if record and record[field_name] %}checked{% endif %}
                       class="w-4 h-4 text-blue-600 rounded border focus:ring-blue-500">
            </label>

            {% elif field.__class__.__name__ == 'ListField' %}
            <div class="mt-1">
                <div class="flex flex-wrap gap-2 p-2 min-h-[42px] border rounded-md bg-white" id="{{ field_name }}-chips">
                    {% if record and record[field_name] %}
                        {% for item in record[field_name] %}
                            <div class="flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-800 rounded" data-value="{{ item }}">
                                <span>{{ item }}</span>
                                <button type="button" onclick="removeListItem('{{ field_name }}', '{{ item }}')" class="text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>

                <div class="mt-2 flex gap-2">
                    <input type="text"
                           id="{{ field_name }}-input"
                           placeholder="Type and press Enter to add..."
                           class="flex-1 rounded-md border py-2 px-3 text-sm focus:border-blue-500 focus:ring-blue-500"
                           onkeydown="handleListInput(event, '{{ field_name }}', '{{ field.field.__class__.__name__ }}')">
                </div>

                <!-- Hidden input to store actual values -->
                <input type="hidden"
                       id="{{ field_name }}"
                       name="{{ field_name }}"
                       value="{{ ','.join(record[field_name]|map('string')) if record and record[field_name] else '' }}">

                {% if field.help_text %}
                <p class="mt-2 text-sm text-gray-500">{{ field.help_text }}</p>
                {% endif %}
            </div>

            {% elif field.__class__.__name__ in ['FileField', 'FileListField'] %}
            <div class="mt-1">
                <div class="flex items-center justify-center w-full">
                    <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors duration-200">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                            <i class="fas fa-cloud-upload-alt text-2xl text-gray-400 mb-2"></i>
                            <p class="mb-2 text-sm text-gray-500">Click to upload or drag and drop</p>
                            <p class="text-xs text-gray-500">
                                {{ ', '.join(field.allowed_extensions) if field.allowed_extensions else 'All files' }}
                                {% if field.max_size %}
                                (Max: {{ field.max_size // (1024*1024) }}MB)
                                {% endif %}
                            </p>
                        </div>
                        <input type="file"
                            id="{{ field_name }}_input"
                            name="{{ field_name }}"
                            class="hidden"
                            {% if field.required and not record %}required{% endif %}
                            {% if field.__class__.__name__ == 'FileListField' %}multiple{% endif %}
                            {% if field.allowed_extensions %}accept="{{ ','.join(field.allowed_extensions) }}"{% endif %}
                            onchange="handleFileSelect(this, '{{ field_name }}')"
                            data-field-name="{{ field_name }}">
                    </label>
                </div>

                <!-- Existing files tracking -->
                <input type="hidden" id="{{ field_name }}_existing" name="{{ field_name }}_existing" value="{{ record[field_name].filename if record and record[field_name] and field.__class__.__name__ == 'FileField' else '' }}">
                {% if field.__class__.__name__ == 'FileListField' and record and record[field_name] %}
                    {% for file in record[field_name] %}
                        <input type="hidden" name="{{ field_name }}_existing[]" value="{{ file.filename }}">
                    {% endfor %}
                {% endif %}
                <input type="hidden" id="{{ field_name }}_deleted" name="{{ field_name }}_deleted" value="">

                <!-- File Display Sections -->
                {% if record and record[field_name] %}
                <div class="mt-4" id="{{ field_name }}-current-files">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">
                        {{ 'Current Files' if field.__class__.__name__ == 'FileListField' else 'Current File'}}
                    </h4>
                    {% if field.__class__.__name__ == 'FileListField' %}
                        {% for file in record[field_name] %}
                        <div class="flex items-center justify-between bg-gray-50 px-3 py-2 rounded-md mb-2" data-file="{{ file.filename }}">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 flex-shrink-0 rounded border border-gray-200 overflow-hidden">
                                    <a href="{{ file.url }}" target="_blank" class="w-full h-full flex items-center justify-center bg-gray-50">
                                        <i class="fas fa-file text-gray-400"></i>
                                    </a>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-sm font-medium text-gray-700">{{ file.filename }}</span>
                                    {% if file.size %}
                                        <span class="text-xs text-gray-500">{{ (file.size / 1024 / 1024)|round(1) }} MB</span>
                                    {% endif %}
                                </div>
                            </div>
                            <button type="button" onclick="removeFile('{{ field_name }}', '{{ file.filename }}')"
                                    class="text-red-500 hover:text-red-700 focus:outline-none transition-colors duration-200">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="flex items-center justify-between bg-gray-50 px-3 py-2 rounded-md" data-file="{{ record[field_name].filename }}">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 flex-shrink-0 rounded border border-gray-200 overflow-hidden">
                                    <a href="{{ record[field_name].url }}" target="_blank" class="w-full h-full flex items-center justify-center bg-gray-50">
                                        <i class="fas fa-file text-gray-400"></i>
                                    </a>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-sm font-medium text-gray-700">{{ record[field_name].filename }}</span>
                                    <span class="text-xs text-gray-500">{{ (record[field_name].size / 1024 / 1024)|round(1) }} MB</span>
                                </div>
                            </div>
                            <button type="button" onclick="removeFile('{{ field_name }}', '{{ record[field_name].filename }}')"
                                    class="text-red-500 hover:text-red-700 focus:outline-none transition-colors duration-200">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- New files preview -->
                <div id="{{ field_name }}-new-files" class="mt-4 hidden">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">
                        {{ 'New Files' if field.__class__.__name__ == 'FileListField' else 'New File'}}
                    </h4>
                    <div class="space-y-2"></div>
                </div>
            </div>

            {% else %}
            <input type="{{ 'datetime-local' if field.__class__.__name__ == 'DateTimeField' else 'date' if field.__class__.__name__ == 'DateField' else 'number' if field.__class__.__name__ == 'IntField' else 'text' }}"
                   id="{{ field_name }}"
                   name="{{ field_name }}"
                   value="{{ record[field_name]|string if record and record[field_name] else '' }}"
                   class="mt-1 block w-full rounded-md border py-2 px-3 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm"
                   {% if field.required %}required{% endif %}>
            {% endif %}

            {% if field.help_text and field.__class__.__name__ != 'ListField' %}
            <p class="mt-2 text-sm text-gray-500">{{ field.help_text }}</p>
            {% endif %}
        </div>
    </div>
    {% endif %}
    {% endfor %}

    {% if show_advanced %}
    {# Advanced Fields Section #}
    <div class="p-6">
        <button type="button"
                onclick="toggleAdvancedFields()"
                class="flex items-center text-sm text-gray-600 hover:text-gray-900 focus:outline-none">
            <i id="advanced-icon" class="fas fa-chevron-right mr-2 transition-transform"></i>
            Built-in Fields
        </button>

        <div id="advanced-fields" class="hidden mt-4 space-y-4">
            {% for field_name, field in model_info.fields.items() %}
            {% if field_name in ['created_at', 'deleted_at'] %}
            <div class="p-4 bg-gray-50 rounded-md">
                <label class="block text-sm font-medium text-gray-700" for="{{ field_name }}">
                    {{ field_name }}
                </label>
                <input type="datetime-local"
                       id="{{ field_name }}"
                       name="{{ field_name }}"
                       value="{{ record[field_name]|string if record else '' }}"
                       class="mt-1 block w-full rounded-md border py-2 px-3 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                <p class="mt-1 text-xs text-gray-500">Leave empty to use default value</p>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endif %}
{% endmacro %}

{% macro render_form_scripts() %}
<script>

const adminRoutePrefix = "{{ admin_route_prefix }}";

// New list field handling functions
function handleListInput(event, fieldName, fieldType) {
    if (event.key === 'Enter') {
        event.preventDefault();
        const input = document.getElementById(`${fieldName}-input`);
        const value = input.value.trim();

        if (!value) return;

        // Validate based on field type
        let processedValue = value;
        let isValid = true;
        let errorMessage = '';

        if (fieldType === 'IntField') {
            if (!/^-?\d+$/.test(value)) {
                isValid = false;
                errorMessage = 'Please enter a valid integer';
            } else {
                processedValue = parseInt(value);
            }
        } else if (fieldType === 'FloatField') {
            if (!/^-?\d*\.?\d+$/.test(value)) {
                isValid = false;
                errorMessage = 'Please enter a valid number';
            } else {
                processedValue = parseFloat(value);
            }
        } else if (fieldType === 'ObjectIdField' || fieldType === 'ReferenceField') {
            if (!/^[0-9a-fA-F]{24}$/.test(value)) {
                isValid = false;
                errorMessage = 'Please enter a valid ObjectId (24 hexadecimal characters)';
            }
        }

        if (!isValid) {
            alert(errorMessage);
            return;
        }

        addListItem(fieldName, processedValue);
        input.value = '';
    }
}

function addListItem(fieldName, value) {
    const chipsContainer = document.getElementById(`${fieldName}-chips`);
    const hiddenInput = document.getElementById(fieldName);

    // Create new chip
    const chip = document.createElement('div');
    chip.className = 'flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-800 rounded';
    chip.dataset.value = value;

    chip.innerHTML = `
        <span>${value}</span>
        <button type="button" onclick="removeListItem('${fieldName}', '${value}')"
                class="text-blue-600 hover:text-blue-800">
            <i class="fas fa-times"></i>
        </button>
    `;

    chipsContainer.appendChild(chip);

    // Update hidden input value
    const currentValues = hiddenInput.value ? hiddenInput.value.split(',') : [];
    if (!currentValues.includes(String(value))) {
        currentValues.push(value);
        hiddenInput.value = currentValues.join(',');
    }
}

function removeListItem(fieldName, value) {
    const chipsContainer = document.getElementById(`${fieldName}-chips`);
    const hiddenInput = document.getElementById(fieldName);

    // Remove chip
    const chip = chipsContainer.querySelector(`[data-value="${value}"]`);
    if (chip) {
        chip.remove();
    }

    // Update hidden input value
    const currentValues = hiddenInput.value.split(',').filter(v => v != value);
    hiddenInput.value = currentValues.join(',');
}



function handleFileSelect(input, fieldName) {
    // Only submit the file input if files are actually selected
    if (input.files.length === 0) {
        input.removeAttribute('name');  // Remove the name attribute so it won't be submitted
    } else {
        // For FileListField, append [] to the name to indicate multiple values
        const isMultiple = input.hasAttribute('multiple');
        input.setAttribute('name', isMultiple ? `${fieldName}[]` : fieldName);
    }

    const files = Array.from(input.files).filter(f => f.name !== '');
    if (files.length === 0) return;

    const container = document.querySelector(`#${fieldName}-new-files`);
    const filesList = container.querySelector('.space-y-2');

    container.classList.remove('hidden');
    filesList.innerHTML = files.map(file => `
        <div class="flex items-center justify-between bg-gray-50 px-3 py-2 rounded-md">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 flex-shrink-0 rounded border border-gray-200 overflow-hidden">
                    <div class="w-full h-full flex items-center justify-center bg-gray-50">
                        <i class="fas fa-file text-gray-400"></i>
                    </div>
                </div>
                <div class="flex flex-col">
                    <span class="text-sm font-medium text-gray-700">${file.name}</span>
                    <span class="text-xs text-gray-500">${(file.size / 1024 / 1024).toFixed(1)} MB</span>
                </div>
            </div>
            <button type="button" onclick="removeNewFile('${fieldName}', '${file.name}')"
                    class="text-red-500 hover:text-red-700 focus:outline-none transition-colors duration-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `).join('');
}

function removeNewFile(fieldName, fileName) {
    const input = document.getElementById(`${fieldName}_input`);
    const dt = new DataTransfer();

    Array.from(input.files)
        .filter(f => f.name !== fileName)
        .forEach(f => dt.items.add(f));

    input.files = dt.files;

    if (dt.files.length === 0) {
        document.querySelector(`#${fieldName}-new-files`).classList.add('hidden');
    }
    handleFileSelect(input, fieldName);
}

function removeFile(fieldName, fileName) {
    // Add to deleted files
    const deletedInput = document.getElementById(`${fieldName}_deleted`);
    const deletedFiles = deletedInput.value ? deletedInput.value.split(',') : [];
    if (!deletedFiles.includes(fileName)) {
        deletedFiles.push(fileName);
        deletedInput.value = deletedFiles.join(',');
    }

    // Remove from display
    const fileElement = document.querySelector(`[data-file="${fileName}"]`);
    if (fileElement) {
        fileElement.remove();
    }
}

function toggleAdvancedFields() {
    const advancedFields = document.getElementById('advanced-fields');
    const advancedIcon = document.getElementById('advanced-icon');
    advancedFields.classList.toggle('hidden');
    advancedIcon.classList.toggle('rotate-90');
}

// Handle drag and drop
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('input[type="file"]').forEach(input => {
        const dropZone = input.closest('label');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-blue-500', 'bg-blue-50');
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');

            const fieldName = input.id.replace('_input', '');
            const dt = new DataTransfer();

            Array.from(e.dataTransfer.files)
                .filter(f => f.name !== '')
                .forEach(f => dt.items.add(f));

            input.files = dt.files;
            handleFileSelect(input, fieldName);
        });
    });
});
</script>
{% endmacro %}